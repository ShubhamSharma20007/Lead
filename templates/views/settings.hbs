<!DOCTYPE html>

<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default"
    data-assets-path="/assets/" data-template="vertical-menu-template-free">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Lead Managment</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet" />

    <link rel="stylesheet" href="/assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="/assets/vendor/libs/apex-charts/apex-charts.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="/assets/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="/assets/js/config.js"></script>
    <style>
        table tr th {
            width: calc(100% /5);
            font-size: 13px;
        }

        table {
            max-height: 60vh;
            width: 100%;
        }

        table tr th:nth-child(1) {
            width: 5% !important;
        }

        .row_data {
            border-bottom: 1px solid lightgray;
        }

        table tr {
            line-height: 35px;
        }

        .table-container {
            position: relative;
        }

        .custom_btn {
            position: absolute;
            right: 5%;
            margin-top: 10px;

        }

        button {
            --primary-color: #645bff;
            --secondary-color: #fff;
            --hover-color: #111;
            --arrow-width: 10px;
            --arrow-stroke: 2px;
            box-sizing: border-box;
            border: 0;
            border-radius: 20px;
            color: var(--secondary-color);
            padding: 1em 1.8em;
            background: var(--primary-color);
            display: flex;
            transition: 0.2s background;
            align-items: center;
            gap: 0.6em;
            font-weight: bold;
        }

        button .arrow-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        button .arrow {
            margin-top: 1px;
            width: var(--arrow-width);
            background: var(--primary-color);
            height: var(--arrow-stroke);
            position: relative;
            transition: 0.2s;
        }

        button .arrow::before {
            content: "";
            box-sizing: border-box;
            position: absolute;
            border: solid var(--secondary-color);
            border-width: 0 var(--arrow-stroke) var(--arrow-stroke) 0;
            display: inline-block;
            top: -3px;
            right: 3px;
            transition: 0.2s;
            padding: 3px;
            transform: rotate(-45deg);
        }

        button:hover {
            background-color: var(--hover-color);
        }

        button:hover .arrow {
            background: var(--secondary-color);
        }

        button:hover .arrow:before {
            right: 0;
        }
    </style>
</head>

<body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->

            {{>Sidebar}}
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">
                <!-- Navbar -->

                {{>navBar}}
                <!-- / Navbar -->

                <!-- Content wrapper -->
                <div class="content-wrapper">
                    <!-- Content -->

                    <div class="container-xxl flex-grow-1 container-p-y">
                        <div class="table-container" style="height: 70vh; overflow-y:scroll">
                            <div class=" col-md-12 cols-12">

                                <table>
                                    <thead>
                                        <tr>
                                            <th>Sr.</th>
                                            <th>Name</th>
                                            <th>Report</th>
                                            <th>Mail Integration</th>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{!-- dynamically data coming --}}

                                    </tbody>
                                </table>
                            </div>

                        </div>
                        <button class="custom_btn">
                            submit
                            <div class="arrow-wrapper">
                                <div class="arrow"></div>

                            </div>
                        </button>



                    </div>

                    <!-- Footer -->
                    {{>footer}}
                    <!-- / Footer -->

                    <div class="content-backdrop fade"></div>
                </div>
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>


</body>

<!-- Main JS -->
<script src="/assets/js/main.js"></script>






<script>
    const alluser = new Promise(async (resolve, reject) => {
        try {
            const res = await fetch('/username')
            const data = await res.json()
            resolve(data)
        } catch (err) {
            reject(err)
        }
    })

    const tbody = document.querySelector('tbody')
    alluser.then(data => {
        data.users.forEach(user => {
            tbody.innerHTML += `
          <tr class="row_data">
            <td>${user.employee_id}</td>
            <td>${user.username}</td>
            <td><input type="checkbox" class="checkBx" data-user-id="${user.employee_id}" data-page="/report" ></td>
            <td><input type="checkbox" class="checkBx" data-user-id="${user.employee_id}" data-page="/mail"></td>
          </tr>
        `
        })

        const reportCheckboxes = document.querySelectorAll('.checkBx');
        reportCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', async function (e) {

                if (this.checked) {
                    const userPk = this.getAttribute('data-user-id');
                    const pagePk = this.getAttribute('data-page');
                    accessDenied(userPk, pagePk, this.checked ? "y" : "n");
                }
                else {
                    const userPk = this.getAttribute('data-user-id');
                    const pagePk = this.getAttribute('data-page');
                    accessDenied(userPk, pagePk, this.checked ? "y" : "n");

                }
            });
        });
    })

    function accessDenied(userPk, pagePk, params) {
        const custom_btn = document.querySelector('.custom_btn')
        custom_btn.addEventListener('click', function () {
            fetch('/access-denied', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userPk, pagePk, params })
            })
                .then(response => response.json())
                .then(data => {
                  if(data.success){
                    showData();
                  }else{
                    console.log('something went wrong')
                  }
                })
                .catch(error => {
                    console.error('Error:', error);

                });
        })
    }
</script>


// get request
<script>
    async function showData() {
        const response = await fetch('/access-denied');
        const data = await response.json();
        const alldata = data.alldata;
        const reportCheckboxes = document.querySelectorAll('.checkBx');

        reportCheckboxes.forEach(checkbox => {
            const userPk = checkbox.getAttribute('data-user-id');
            const pagePk = checkbox.getAttribute('data-page');
            const matchingData = alldata.find(item => item.userPk === userPk && item.pagePk === pagePk && item.access_b === "y");
            if (matchingData) {
                checkbox.checked = true;
            }
        });
    }

    showData();
</script>



</html>